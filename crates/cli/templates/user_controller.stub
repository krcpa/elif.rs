use elif_http::{ElifRequest, ElifResponse, HttpResult};
use elif_http_derive::{controller, get, post, put, delete};
use crate::services::user_service::UserService;
use std::sync::Arc;

#[controller("/api/users")]
pub struct UserController {
    user_service: Arc<UserService>,
}

impl UserController {
    pub fn new(user_service: Arc<UserService>) -> Self {
        Self { user_service }
    }

    #[get("")]
    pub async fn index(&self, _req: ElifRequest) -> HttpResult<ElifResponse> {
        let users = self.user_service.list_users().await?;
        ElifResponse::ok().json(&users)
    }

    #[get("/{id}")]
    pub async fn show(&self, req: ElifRequest) -> HttpResult<ElifResponse> {
        let id = req.path_param("id")?;
        let user = self.user_service.get_user(id).await?;
        ElifResponse::ok().json(&user)
    }

    #[post("")]
    pub async fn create(&self, req: ElifRequest) -> HttpResult<ElifResponse> {
        let data = req.json_body().await?;
        let user = self.user_service.create_user(data).await?;
        ElifResponse::created().json(&user)
    }

    #[put("/{id}")]
    pub async fn update(&self, req: ElifRequest) -> HttpResult<ElifResponse> {
        let id = req.path_param("id")?;
        let data = req.json_body().await?;
        let user = self.user_service.update_user(id, data).await?;
        ElifResponse::ok().json(&user)
    }

    #[delete("/{id}")]
    pub async fn destroy(&self, req: ElifRequest) -> HttpResult<ElifResponse> {
        let id = req.path_param("id")?;
        self.user_service.delete_user(id).await?;
        ElifResponse::no_content()
    }
}